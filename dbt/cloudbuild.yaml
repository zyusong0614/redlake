substitutions:
  _DBT_DOCS_BUCKET: redlake-dbt-docs

steps:
  - name: python:3.11
    id: "run-dbt"
    entrypoint: bash
    args:
      - -c
      - |
        echo "ğŸ“ åˆ‡æ¢åˆ° dbt å­ç›®å½•"
        cd dbt

        echo "ğŸ å®‰è£…ä¾èµ–..."
        apt-get update && apt-get install -y git gcc
        pip install --upgrade pip
        pip install dbt-bigquery

        echo "ğŸ“¦ å®‰è£… dbt-expectations..."
        dbt deps --profiles-dir .

        echo "â–¶ï¸ æ‰§è¡Œ dbt..."
        dbt run --profiles-dir .
        dbt test --profiles-dir .
        dbt docs generate --profiles-dir .

  - name: gcr.io/cloud-builders/gsutil
    id: "upload-docs"
    args:
      - -m
      - rsync
      - -r
      - dbt/target/
      - gs://${_DBT_DOCS_BUCKET}/

timeout: 1800s

logsBucket: gs://redlake-build-logs/
