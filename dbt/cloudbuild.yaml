substitutions:
  _DBT_DOCS_BUCKET: redlake-dbt-docs

steps:
  - name: gcr.io/cloud-builders/gcloud
    id: "Install system dependencies & dbt"
    entrypoint: bash
    args:
      - -c
      - |
        echo "ğŸ§° Update apt & install pip, gsutil, git"
        apt-get update && apt-get install -y python3-pip git

        echo "ğŸ Upgrade pip & install dbt..."
        pip3 install --upgrade pip
        pip3 install dbt-bigquery

  - name: gcr.io/cloud-builders/gcloud
    id: "Run dbt"
    entrypoint: bash
    args:
      - -c
      - |
        echo "ğŸ“¦ Resolve dbt deps..."
        dbt deps

        echo "â–¶ï¸ Run dbt models"
        dbt run

        echo "ğŸ§ª Run dbt tests"
        dbt test

        echo "ğŸ“š Generate docs"
        dbt docs generate

  - name: gcr.io/cloud-builders/gsutil
    id: "Upload docs"
    args:
      - -m
      - rsync
      - -r
      - target/
      - gs://${_DBT_DOCS_BUCKET}/

timeout: 1800s


logsBucket: gs://redlake-build-logs/
