substitutions:
  _DBT_DOCS_BUCKET: redlake-dbt-docs

steps:
  # Step 1: å®‰è£…å¹¶æ‰§è¡Œ dbt æ‰€æœ‰å‘½ä»¤
  - name: python:3.11
    id: "run-dbt"
    entrypoint: bash
    args:
      - -c
      - |
        echo "ğŸ“ åˆ‡æ¢åˆ° dbt å­ç›®å½•"
        cd dbt
        echo "ğŸ å®‰è£…ä¾èµ–..."
        apt-get update && apt-get install -y git gcc
        pip install --upgrade pip
        pip install dbt-bigquery

        echo "ğŸ“¦ å®‰è£… dbt-expectations..."
        dbt deps --profiles-dir /workspace

        echo "â–¶ï¸ æ‰§è¡Œ dbt..."
        dbt run --profiles-dir /workspace
        dbt test --profiles-dir /workspace
        dbt docs generate --profiles-dir /workspace

  # Step 2: ä½¿ç”¨å®˜æ–¹ gsutil é•œåƒä¸Šä¼ æ–‡æ¡£åˆ° GCS
  - name: gcr.io/cloud-builders/gsutil
    id: "upload-docs"
    args:
      - -m
      - rsync
      - -r
      - target/
      - gs://${_DBT_DOCS_BUCKET}/

timeout: 1800s



logsBucket: gs://redlake-build-logs/
