substitutions:
  _DBT_DOCS_BUCKET: redlake-dbt-docs

steps:
  - name: python:3.11
    entrypoint: bash
    args:
      - -c
      - |
        echo "ğŸ å®‰è£… pip & dbt..."
        apt-get update && apt-get install -y git gcc
        pip install --upgrade pip
        pip install dbt-bigquery google-cloud-storage

        echo "ğŸ“¦ å®‰è£… dbt-expectationsï¼ˆé€šè¿‡ dbt depsï¼‰..."
        dbt deps --profiles-dir /workspace

        echo "â–¶ï¸ è¿è¡Œ dbt..."
        dbt run --profiles-dir /workspace
        dbt test --profiles-dir /workspace
        dbt docs generate --profiles-dir /workspace

        echo "â˜ï¸ ä¸Šä¼ æ–‡æ¡£åˆ° GCS..."
        pip install --upgrade google-cloud-sdk
        curl https://sdk.cloud.google.com | bash
        exec -l $SHELL
        gsutil -m rsync -r target/ gs://${_DBT_DOCS_BUCKET}/

timeout: 1800s



logsBucket: gs://redlake-build-logs/
